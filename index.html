<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Кликер" />
  <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/354/star_2b50.png" />
  <title>Кликер — без лагов, слоты и ракета</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Прелоад аудио строго по пути github/music/... -->
  <link rel="preload" as="audio" href="github/music/music_game.mp3">
  <link rel="preload" as="audio" href="github/music/click.mp3">

  <style>
    :root{
      --blur-bg:6px;
      --cell-h:88px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --header-h: 56px;
      --footer-h: 88px;
      --stage-size: clamp(220px, min(78vw, 58svh), 420px);
      --raise: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:'Inter',sans-serif;
      background:#0b1026;
      margin:0; min-height:100%;
      display:flex; align-items:center; justify-content:center;
      padding:16px; color:#fff; overflow:hidden;
    }
    .game-wrapper{
      position:relative;
      width:  min(100vw, calc(100dvh * 9 / 16));
      height: min(100dvh, calc(100vw * 16 / 9));
      aspect-ratio: 9 / 16;
      border-radius:20px; overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.6);
      background:#000;
    }
    .game-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;transition:opacity .35s ease, filter .35s ease}
    .dim-3{filter:brightness(0.97)}
    .game-content{
      position:relative; z-index:1; height:100%;
      display:flex; flex-direction:column; justify-content:flex-start;
      padding:calc(10px + var(--safe-top)) 12px calc(var(--footer-h) + 12px + var(--safe-bottom));
      background:rgba(0,0,0,.28)
    }

    .preloader{position:absolute;inset:0;background:#0b1026;display:flex;align-items:center;justify-content:center;z-index:120;transition:opacity .35s ease}
    .preloader.hidden{opacity:0;pointer-events:none;visibility:hidden;display:none}
    .preloader-box{display:flex;flex-direction:column;align-items:center;gap:18px;width:82%;max-width:320px;text-align:center}
    .preloader-logo{width:72px;height:72px;display:grid;place-items:center;border-radius:18px;background:rgba(255,255,255,.06);box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.08)}
    .preloader-spinner{width:54px;height:54px;border-radius:9999px;border:4px solid rgba(255,255,255,.18);border-top-color:#facc15;animation:spin 1s linear infinite;filter:drop-shadow(0 0 8px rgba(250,204,21,.4))}
    .preloader-title{font-weight:800;font-size:18px;color:#fff}
    .preloader-sub{font-size:12px;color:rgba(255,255,255,.75)}
    .preloader-bar{width:100%;height:10px;background:rgba(255,255,255,.1);border-radius:9999px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .preloader-fill{height:100%;width:0%;background:linear-gradient(90deg,#fde047,#f59e0b);border-radius:9999px;transition:width .16s ease}
    @keyframes spin{to{transform:rotate(360deg)}}

    .avatar-stage{width:var(--stage-size);height:var(--stage-size)}
    .podium{position:absolute;bottom:-26px;left:50%;transform:translateX(-50%);width:200px;height:60px;border-radius:50%;background:radial-gradient(ellipse at 50% 50%,#FBBF24 0%,#F59E0B 65%,rgba(0,0,0,0) 70%);filter:drop-shadow(0 0 6px #facc15);z-index:5;animation:pulse 3s ease-in-out infinite}
    .character{position:relative;top:6px;cursor:pointer;user-select:none;z-index:6;animation:land .6s cubic-bezier(.2,.9,.2,1) 60ms both;transition:transform .1s ease-in-out}
    .character:active,.character.pressed{transform:translateY(6px) scale(.98)!important}
    @keyframes land{0%{transform:translateY(-24px) scale(1.02);filter:drop-shadow(0 6px 10px rgba(0,0,0,.45))}70%{transform:translateY(2px)}100%{transform:translateY(0)}}
    .pet{position:absolute;right:-6px;bottom:2px;width:39%;max-width:138px;pointer-events:none;display:none;z-index:7;filter:drop-shadow(0 6px 14px rgba(0,0,0,.55))}
    .pet.show{display:block}

    .big-score{margin-top:-8px}
    #score-big{font-size:clamp(28px,9vw,56px)}
    .floating-coin{position:absolute;left:0;top:0;display:flex;align-items:center;gap:6px;font-size:1.1rem;font-weight:800;color:#facc15;pointer-events:none;text-shadow:0 2px 4px rgba(0,0,0,.55);z-index:60;opacity:0;will-change:transform,opacity}
    @keyframes floatUp{from{opacity:1;transform:translate(var(--x,0), var(--y,0))}to{opacity:0;transform:translate(var(--x,0), calc(var(--y,0) - 100px))}}
    @keyframes pulse{0%,100%{filter:drop-shadow(0 0 8px #facc15) drop-shadow(0 0 14px #f59e0b)}50%{filter:drop-shadow(0 0 18px #facc15) drop-shadow(0 0 30px #f59e0b)}}

    .screen{
      position:absolute; left:0; right:0;
      top:calc(var(--header-h) + 12px);
      bottom:calc(var(--footer-h) + 12px);
      margin:12px; padding:12px 12px 16px; border-radius:16px;
      background:rgba(0,0,0,.65); backdrop-filter:blur(var(--blur-bg)); -webkit-backdrop-filter:blur(var(--blur-bg));
      overflow:auto; display:none; z-index:30
    }
    .screen.active{display:block}
    .screen, .screen *{color:#fff}
    .screen-title{display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;background:linear-gradient(to bottom, rgba(0,0,0,.7), rgba(0,0,0,0));padding:6px 0 10px;z-index:1}
    .screen-close{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.12)}
    .tab-btn[aria-selected="true"]{outline:2px solid #e5e7eb;background-color:rgb(255 255 255 / .08)}
    .scene-dim .center-area{filter:blur(1px) brightness(.92)}

    .slots-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .slots-box{position:relative;width:min(300px,86%);border-radius:18px;padding:12px;background:linear-gradient(180deg,rgba(255,191,41,.35),rgba(255,159,8,.25));box-shadow:inset 0 0 0 4px rgba(255,255,255,.15),0 10px 30px rgba(0,0,0,.5)}
    .slots-window{position:relative;overflow:hidden;height:var(--cell-h);background:rgba(0,0,0,.25);border-radius:12px;box-shadow:inset 0 0 0 3px rgba(255,255,255,.14)}
    .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;height:100%;padding:8px}
    .reel{position:relative;overflow:hidden;border-radius:10px;background:rgba(0,0,0,.18);box-shadow:inset 0 0 0 2px rgba(255,255,255,.08)}
    .reel-inner{position:absolute;left:0;right:0;top:0;transform:translateY(0);will-change:transform}
    .cell{display:flex;align-items:center;justify-content:center;height:var(--cell-h);font-weight:900;font-size:52px;text-shadow:0 2px 4px rgba(0,0,0,.35)}
    .slots-buttons{display:flex;gap:10px;justify-content:center}
    .win-banner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.7);padding:14px 18px;border-radius:14px;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);color:#fff;font-weight:800;font-size:26px;opacity:0;pointer-events:none;z-index:3}
    .win-banner.show{animation:popIn .7s ease forwards}
    @keyframes popIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.6)}60%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}

    .rocket-stage{position:relative;width:min(300px,86%);height:190px;border-radius:16px;background:linear-gradient(180deg,rgba(16,20,45,.9),rgba(10,14,32,.9));box-shadow:inset 0 0 0 3px rgba(255,255,255,.08),0 10px 30px rgba(0,0,0,.5);overflow:hidden}
    .rocket-sky{position:absolute;inset:-14%;will-change:transform;background: radial-gradient(2px 2px at 20% 30%,rgba(255,255,255,.35),transparent 60%), radial-gradient(2px 2px at 70% 20%,rgba(255,255,255,.25),transparent 60%), radial-gradient(2px 2px at 40% 70%,rgba(255,255,255,.3),transparent 60%), linear-gradient(180deg,rgba(20,24,50,.8),rgba(10,12,30,.9)); filter:brightness(.95) }
    .rocket-curve{position:absolute;left:0;bottom:12px;width:100%;height:2px;background:linear-gradient(90deg,rgba(156,163,175,.1),rgba(168,85,247,.9));opacity:.7;transform-origin:left bottom}
    .rocket-mult{position:absolute;top:10px;left:0;right:0;text-align:center;font-weight:800;font-size:34px;color:#c084fc;text-shadow:0 2px 6px rgba(0,0,0,.6)}
    .rocket-sprite{position:absolute;left:12px;bottom:12px;width:44px;height:44px;filter:drop-shadow(0 0 10px rgba(255,160,64,.55)) drop-shadow(0 0 18px rgba(168,85,247,.4));transform:translate(0,0) rotate(14deg);will-change:transform}
    .rocket-sprite .r-ship{position:absolute;inset:0;display:grid;place-items:center;font-size:44px}
    .rocket-sprite .r-boom{position:absolute;inset:0;display:grid;place-items:center;font-size:44px;opacity:0}
    .rocket-sprite.boom .r-ship{opacity:0}
    .rocket-sprite.boom .r-boom{opacity:1}
    .rocket-sprite.shake{animation:shake .35s ease-in-out 2}
    @keyframes shake{0%,100%{transform:translate(0,0) rotate(14deg)}25%{transform:translate(4px,-3px) rotate(16deg)}50%{transform:translate(-3px,5px) rotate(10deg)}75%{transform:translate(2px,-2px) rotate(15deg)}}
    .rocket-banner{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.8);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);font-weight:800;opacity:0;pointer-events:none}
    .rocket-banner.show{animation:rbIn .6s ease forwards}
    @keyframes rbIn{0%{opacity:0;transform:translate(-50%,-50%) scale(.7)}70%{opacity:1;transform:translate(-50%,-50%) scale(1.06)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}

    .intro{position:absolute;inset:0;z-index:200;background:linear-gradient(180deg,rgba(5,7,18,.9),rgba(11,16,38,.88));display:none}
    .intro.show{display:block}
    .intro-wrap{position:absolute;left:0;right:0;bottom:0;top:0;display:flex;align-items:center;justify-content:center;padding:16px}
    .intro-card{width:100%;max-width:420px;display:grid;grid-template-columns:58% 42%;gap:14px;align-items:center;background:rgba(255,255,255,.06);border-radius:16px;padding:12px 16px 12px 12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 10px 30px rgba(0,0,0,.5)}
    .intro-ava{width:100%;aspect-ratio:1/1;display:block;object-fit:contain;filter:drop-shadow(0 6px 16px rgba(0,0,0,.55));transform:scale(1.5);transform-origin:center bottom}
    .intro-bubble{position:relative;background:rgba(0,0,0,.5);padding:10px;border-radius:10px;margin-left:-14px;margin-right:10px}
    .intro-bubble:before{content:"";position:absolute;left:-10px;top:18px;width:0;height:0;border-top:8px solid transparent;border-bottom:8px solid transparent;border-right:8px solid rgba(0,0,0,.5)}
    .intro-title{font-weight:800;font-size:20px;margin-bottom:6px}
    .intro-text{font-size:13px;opacity:.95}
    .intro-actions{display:flex;gap:8px;margin-top:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;font-weight:800}
    .btn-primary{background:#f59e0b;color:#0b1026}
    .btn-ghost{background:rgba(255,255,255,.14)}

    .tg-user{position:absolute;right:12px;top:12px;z-index:20;display:none;align-items:center;padding:0;border-radius:9999px;background:transparent;box-shadow:none}
    .tg-user.show{display:flex}
    .tg-user img{width:36px;height:36px;border-radius:9999px;object-fit:cover;cursor:pointer;box-shadow:0 0 0 2px rgba(255,255,255,.18),0 6px 16px rgba(0,0,0,.35)}

    .game-content > footer{position:absolute;left:12px;right:12px;bottom:10px;z-index:10}
    .center-area{will-change:transform;transform:translateY(calc(-1 * var(--raise)))}

    @media (max-width:360px){
      :root{ --cell-h:74px }
      .cell{font-size:44px}
    }
    @media (max-height:640px){
      :root{ --raise: 8px }
    }

    /* Кнопка покупки уровня */
    #buy-level{width:100%;margin-top:8px}
  </style>
</head>
<body>
<div class="game-wrapper" id="wrapper">
  <!-- TG User badge -->
  <div id="tgUser" class="tg-user" role="button" aria-label="Открыть профиль в Telegram" title="Открыть профиль">
    <img id="tgAva" alt="avatar" src="" />
  </div>

  <!-- АУДИО -->
  <audio id="bgm" src="github/music/music_game.mp3" preload="auto" loop playsinline></audio>
  <audio id="sfx-click" src="github/music/click.mp3" preload="auto" playsinline></audio>

  <div id="preloader" class="preloader" aria-live="polite" aria-busy="true">
    <div class="preloader-box">
      <div class="preloader-logo">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="#facc15" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.787 1.402 8.173L12 18.896l-7.336 3.274 1.402-8.173L.132 9.21l8.2-1.192L12 .587z"/></svg>
      </div>
      <div class="preloader-spinner" aria-hidden="true"></div>
      <div class="preloader-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div id="preloader-fill" class="preloader-fill"></div></div>
      <div class="preloader-title">Загрузка…</div>
      <div class="preloader-sub">Готовим комнату и мини-игры</div>
    </div>
  </div>

  <!-- Сторож прелоадера -->
  <script>
    (function(){
      var p=document.getElementById('preloader'); if(!p) return;
      var hid=false; function hide(){ if(hid) return; hid=true; try{ p.classList.add('hidden') }catch(_){ } }
      window.addEventListener('load', hide, {once:true});
      setTimeout(hide, 7000);
    })();
  </script>

  <section id="intro" class="intro" aria-hidden="true">
    <div class="intro-wrap">
      <div class="intro-card">
        <img src="https://i.postimg.cc/rwFbVPMr/vera-1-Photoroom.png" alt="Вера" class="intro-ava">
        <div class="intro-bubble">
          <div class="intro-title">Привет! Я Вера 👋</div>
          <div class="intro-text">
            <ul class="list-disc list-inside space-y-1">
              <li>Кликай по герою — копи <b>💵</b>.</li>
              <li>Уровни <b>покупаются</b>: 2-й → 600, 3-й → 900, …, 7-й → 2100.</li>
              <li>«+1 к деньгам»: 500 → 800 → 1100 (до 5 уровня максимум 3 раза), после 5 уровня — безлимит, +300 к цене.</li>
            </ul>
            <div class="intro-actions">
              <button id="intro-start" class="btn btn-primary">Погнали!</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <img id="bg" class="game-bg" src="https://i.postimg.cc/bYC9rVNc/Chat-GPT-Image-16-2025-17-40-13.png" alt="Фон: Уровень">

  <div id="game" class="game-content">
    <header id="topbar" class="flex justify-between items-center w-full mb-2">
      <div class="flex items-center gap-2">
        <div class="flex items-center gap-2 bg-black/40 px-3 py-2 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-sky-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"/></svg>
          <span class="text-white/90 text-sm">LVL</span>
          <span id="level" class="font-extrabold">1</span>
        </div>
        <div class="flex items-center gap-2 bg-black/40 px-3 py-2 rounded-full">
          <span class="w-5 h-5 grid place-items-center font-extrabold">💵</span>
          <span id="score" class="font-bold text-lg">0</span>
        </div>
        <button id="settings-btn" class="flex items-center gap-2 bg-black/40 px-3 py-2 rounded-full" title="Настройки">
          <span class="w-5 h-5 grid place-items-center">⚙️</span>
        </button>
      </div>
    </header>

    <div id="settings-panel" class="absolute left-3 right-3 top-20 z-40 bg-black/70 backdrop-blur p-3 rounded-xl hidden">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm">Громкость музыки</span>
        <input id="vol-music" type="range" min="0" max="1" step="0.01" value="0.1" class="w-40">
      </div>
      <div class="flex items-center justify-between mb-3">
        <span class="text-sm">Громкость клика</span>
        <input id="vol-sfx" type="range" min="0" max="1" step="0.01" value="0.8" class="w-40">
      </div>
      <button id="reset-progress" class="w-full px-3 py-2 rounded-lg bg-red-500/70 hover:bg-red-500 text-white font-semibold">Сбросить прогресс (деньги и уровень)</button>
    </div>

    <div id="level-box" class="w-full px-1 mb-2">
      <div class="flex items-center justify-between text-xs text-white/80 mb-1">
        <span>Следующий уровень</span>
        <span id="lvl-caption"><span id="lvl-progress">0</span></span>
      </div>
      <div class="w-full bg-white/10 rounded-full h-2">
        <div id="lvl-progress-bar" class="h-2 bg-sky-400 rounded-full" style="width:0%"></div>
      </div>

      <!-- мини-кнопки -->
      <div id="sub-mini" class="flex flex-col gap-1 items-end mt-1" style="transform:scale(0.8);transform-origin:right top;">
        <div class="flex items-center gap-1 bg-black/40 px-1.5 py-1 rounded-full">
          <button id="sub-open" class="text-[11px] px-2 py-0.5 rounded-full bg-purple-500/40 hover:bg-purple-500/60 font-semibold">Подписаться</button>
          <img src="https://i.postimg.cc/TP1Cy2ZT/photo-2024-11-20-16-11-48.jpg" alt="Вера" class="w-6 h-6 rounded-full object-cover" />
        </div>
        <div class="flex items-center gap-1 bg-black/40 px-1.5 py-1 rounded-full">
          <button id="sub-open-2" class="text-[11px] px-2 py-0.5 rounded-full bg-purple-500/40 hover:bg-purple-500/60 font-semibold">Подписаться</button>
          <svg viewBox="0 0 64 64" class="w-6 h-6 rounded-full" aria-hidden="true">
            <defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#0ea5e9"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs>
            <circle cx="32" cy="32" r="32" fill="url(#g2)"/><text x="50%" y="58%" text-anchor="middle" font-size="34" font-family="Arial,Helvetica,sans-serif" fill="#0b1026" font-weight="800">U</text>
          </svg>
        </div>
      </div>
      <!-- /мини-кнопки -->

      <!-- Кнопка покупки уровня -->
      <button id="buy-level" class="px-3 py-2 rounded-lg bg-emerald-500/80 hover:bg-emerald-500 text-black font-extrabold hidden">
        Купить уровень за <span id="level-cost">0</span> 💵
      </button>
    </div>

    <main class="center-area flex flex-col items-center justify-center flex-grow">
      <div class="big-score flex items-center gap-2 mb-2">
        <span class="w-10 h-10 grid place-items-center text-3xl font-extrabold leading-none">💵</span>
        <span id="score-big" class="font-bold">0</span>
      </div>

      <div class="avatar-stage relative mb-4">
        <div class="podium"></div>
        <img id="character" src="https://i.postimg.cc/zXWCKfvw/image.png" alt="Игровой персонаж" class="character w-full h-full drop-shadow-lg">
        <img id="pet-dog" class="pet" src="https://i.postimg.cc/76NmJx8X/dog.png" alt="Собака">
      </div>

      <div class="w-full max-w-xs mt-1">
        <div class="flex justify-between text-sm font-semibold mb-1 text-white">
          <span>Энергия</span><span><span id="energy-level">100</span> / <span id="max-energy">100</span></span>
        </div>
        <div class="w-full bg-black/60 rounded-full h-4">
          <div id="energy-bar" class="bg-gradient-to-r from-yellow-400 to-amber-500 h-4 rounded-full" style="width:100%"></div>
        </div>
      </div>
    </main>

    <!-- Экраны -->
    <section id="screen-income" class="screen" aria-hidden="true">
      <div class="screen-title"><h2 class="text-xl font-bold">Доход</h2><button class="screen-close" data-close>✕ Закрыть</button></div>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between bg-white/10 p-3 rounded-lg"><span>💵 за клик</span><strong id="stat-per-click">1</strong></div>
        <div class="flex justify-between bg-white/10 p-3 rounded-lg"><span>Восстановление энергии / сек</span><strong id="stat-regen">1</strong></div>
        <div class="flex justify-between bg-white/10 p-3 rounded-lg"><span>Макс. энергия</span><strong id="stat-max-energy">100</strong></div>
      </div>
    </section>

    <section id="screen-upgrades" class="screen" aria-hidden="true">
      <div class="screen-title"><h2 class="text-xl font-bold">Улучшения</h2><button class="screen-close" data-close>✕ Закрыть</button></div>
      <div class="grid gap-3 text-sm">
        <div class="bg-white/10 p-3 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <div>
              <p class="font-semibold">+1 к деньгам за клик</p>
              <p class="text-xs text-white/80">До 3 раз (500→800→1100), после 5 уровня — безлимит, цена +300.</p>
            </div>
            <button id="buy-click" class="px-3 py-1 rounded-md bg-yellow-500/30 hover:bg-yellow-500/50">
              Купить за <span id="cost-click">500</span> 💵
            </button>
          </div>
        </div>
        <div class="bg-white/10 p-3 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <div><p class="font-semibold">+10 к максимальной энергии</p><p class="text-xs text-white/80">Больше кликов подряд</p></div>
            <button id="buy-max" class="px-3 py-1 rounded-md bg-blue-500/30 hover:bg-blue-500/50">Купить за <span id="cost-max">30</span> 💵</button>
          </div>
        </div>
        <div class="bg-white/10 p-3 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <div><p class="font-semibold">+0.5 к восстановлению энергии</p><p class="text-xs text-white/80">Энергия быстрее возвращается</p></div>
            <button id="buy-regen" class="px-3 py-1 rounded-md bg-green-500/30 hover:bg-green-500/50">Купить за <span id="cost-regen">25</span> 💵</button>
          </div>
        </div>
      </div>
    </section>

    <section id="screen-game" class="screen" aria-hidden="true">
      <div class="screen-title"><h2 class="text-xl font-bold">Игра</h2><button class="screen-close" data-close>✕ Закрыть</button></div>
      <div class="flex gap-2 mb-3">
        <button id="tabMiniSlots" class="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold outline outline-1 outline-white/10">Слоты</button>
        <button id="tabMiniRocket" class="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold outline outline-1 outline-white/10">Ракета</button>
      </div>

      <div id="gameSlots" class="slots-wrap">
        <div class="slots-box">
          <div class="slots-window">
            <div class="reels">
              <div class="reel"><div class="reel-inner" id="reel0"></div></div>
              <div class="reel"><div class="reel-inner" id="reel1"></div></div>
              <div class="reel"><div class="reel-inner" id="reel2"></div></div>
            </div>
          </div>
          <div id="slotsWinBanner" class="win-banner">+0 💵</div>
        </div>
        <div class="slots-buttons">
          <button id="spinBtn" class="px-4 py-2 rounded-lg bg-amber-500/80 hover:bg-amber-500 font-bold">SPIN (−5 💵)</button>
          <button id="paytableBtn" class="px-4 py-2 rounded-lg bg-white/15 hover:bg-white/25 font-semibold">Таблица</button>
        </div>
        <div id="cooldownText" class="text-sm text-white/80">Готово к спину</div>
        <div id="paytable" class="hidden text-sm bg-white/10 p-3 rounded-lg w-full max-w-xs">
          <p class="font-semibold mb-1">Выплаты (3 в ряд):</p>
          <ul class="list-disc list-inside space-y-0.5">
            <li>🍒 ×3 → +15 💵</li><li>🍋 ×3 → +20 💵</li><li>🍉 ×3 → +40 💵</li><li>🍇 ×3 → +60 💵</li><li>🍀 ×3 → +30 💵</li><li>🍑 ×3 → +35 💵</li><li>7️⃣ ×3 → +250 💵</li><li>Любые 2 одинаковых → +5 💵</li><li>Два 7️⃣ → +40 💵</li>
          </ul>
        </div>
      </div>

      <div id="gameRocket" class="hidden">
        <div class="flex flex-col items-center gap-3">
          <div class="rocket-stage">
            <div class="rocket-sky"></div>
            <div class="rocket-curve" id="rocketCurve"></div>
            <div id="rocketMult" class="rocket-mult">x1.00</div>
            <div id="rocketSprite" class="rocket-sprite" aria-live="polite"><span class="r-ship">🚀</span><span class="r-boom">💥</span></div>
            <div id="rocketBanner" class="rocket-banner"></div>
          </div>
          <div class="w-full max-w-xs grid gap-2">
            <div class="flex justify-between items-center bg-white/10 p-2 rounded-lg">
              <label class="text-sm">Ставка</label>
              <div class="flex items-center gap-2">
                <button id="rBetMinus" class="px-2 py-1 text-sm rounded-md bg-white/10 hover:bg-white/20">−10</button>
                <input id="rocketBet" class="w-20 bg-black/40 px-2 py-1 rounded-md text-right font-semibold" type="number" value="20" min="1" step="1"/>
                <span class="text-sm">💵</span>
                <button id="rBetPlus" class="px-2 py-1 text-sm rounded-md bg-white/10 hover:bg-white/20">+10</button>
              </div>
            </div>
            <div class="flex justify-between items-center bg-white/10 p-2 rounded-lg">
              <label class="text-sm">Автовывод</label>
              <div class="flex items-center gap-2">
                <input id="rocketAuto" class="w-20 bg-black/40 px-2 py-1 rounded-md text-right font-semibold" type="number" value="0" min="0" step="0.01"/>
                <span class="text-sm">×</span>
                <button id="rAuto2" class="px-2 py-1 text-sm rounded-md bg-white/10 hover:bg-white/20">x2</button>
                <button id="rAuto3" class="px-2 py-1 text-sm rounded-md bg-white/10 hover:bg-white/20">x3</button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <button id="rocketStart" class="px-3 py-2 rounded-lg bg-amber-500/80 hover:bg-amber-500 font-extrabold">СТАРТ</button>
              <button id="rocketCashout" class="px-3 py-2 rounded-lg bg-emerald-500/70 hover:bg-emerald-500 font-extrabold" disabled>ВЫВЕСТИ</button>
            </div>
            <p id="rocketHint" class="text-xs text-white/70 text-center">Нажми «СТАРТ», множитель растёт. Успей «ВЫВЕСТИ» до взрыва!</p>
          </div>
        </div>
      </div>
    </section>

    <section id="screen-skins" class="screen" aria-hidden="true">
      <div class="screen-title"><h2 class="text-xl font-bold">Скины</h2><button class="screen-close" data-close>✕ Закрыть</button></div>
      <div id="skin-preview" class="fixed inset-0 z-40 hidden items-center justify-content-center bg-black/60 backdrop-blur">
        <div class="relative bg-black/80 p-4 rounded-2xl w-[90%] max-w-xs border border-white/10">
          <button id="skin-preview-close" class="absolute -top-3 -right-3 w-10 h-10 rounded-full bg-white/15 hover:bg-white/25 grid place-items-center text-lg">✕</button>
          <img id="skin-preview-img" src="" alt="Предпросмотр" class="w-full h-auto object-contain rounded-xl mb-2">
          <div id="skin-preview-name" class="font-extrabold mb-1">—</div>
          <div class="text-xs text-white/70 mb-2">Предпросмотр внешнего вида персонажа в игре.</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="skin-preview-buy" class="px-3 py-2 rounded-lg bg-yellow-500/80 text-black font-extrabold">Купить за 10 💵</button>
            <button id="skin-preview-equip" class="px-3 py-2 rounded-lg bg-emerald-500/80 text-black font-extrabold">Надеть</button>
          </div>
        </div>
      </div>
      <div class="text-xs text-white/70 mb-3">Персонажи стоят по <b>10 💵</b>. По клику на <b>название</b> — предпросмотр перед покупкой. Надетый скин можно снять.</div>
      <div id="skins-list" class="grid gap-3 text-sm"></div>
      <p class="text-xs text-white/60 mt-3">Питомец «Собака» (10 💵) — появляется справа от персонажа; его можно включать и выключать.</p>
    </section>

    <section id="screen-donates" class="screen" aria-hidden="true">
      <div class="screen-title"><h2 class="text-xl font-bold">Донаты (Telegram ⭐)</h2><button class="screen-close" data-close>✕ Закрыть</button></div>
      <div class="grid gap-3 text-sm">
        <div class="flex justify-between bg-white/10 p-3 rounded-lg"><span>Баланс звёзд Telegram</span><strong id="tg-stars-balance">0 ⭐</strong></div>
        <div class="grid gap-2">
          <div class="flex flex-wrap gap-2">
            <button class="donate-btn px-3 py-2 rounded-lg bg-purple-500/80 hover:bg-purple-500 text-white font-semibold" data-amt="10">Задонатить 10 ⭐</button>
            <button class="donate-btn px-3 py-2 rounded-lg bg-purple-500/80 hover:bg-purple-500 text-white font-semibold" data-amt="50">Задонатить 50 ⭐</button>
            <button class="donate-btn px-3 py-2 rounded-lg bg-purple-500/80 hover:bg-purple-500 text-white font-semibold" data-amt="100">Задонатить 100 ⭐</button>
          </div>
          <p class="text-xs text-white/60">Оплата откроется в Telegram. После успешного платежа баланс ⭐ увеличится автоматически.</p>
        </div>
        <div class="bg-white/5 rounded-lg p-3">
          <div class="flex items-center justify-between"><div class="font-semibold">Настройки донатов</div><button id="donate-settings-toggle" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20 text-xs">⚙️ Открыть</button></div>
          <div id="donate-settings" class="mt-2 hidden grid gap-2">
            <p class="text-xs text-white/70">Два варианта: <b>вставь готовые ссылки</b> на инвойсы Stars (10/50/100), либо <b>укажи URL своего сервера</b> — игра сама запросит ссылку через <code>/invoice?amount=...</code>.</p>
            <div class="mt-1 p-2 rounded bg-white/5">
              <div class="font-semibold mb-1">Ручные ссылки (Stars инвойсы)</div>
              <label class="grid gap-1"><span class="text-xs">Инвойс 10 ⭐</span><input id="invoice-10" class="bg-black/40 px-2 py-1 rounded" /></label>
              <label class="grid gap-1"><span class="text-xs">Инвойс 50 ⭐</span><input id="invoice-50" class="bg-black/40 px-2 py-1 rounded" /></label>
              <label class="grid gap-1"><span class="text-xs">Инвойс 100 ⭐</span><input id="invoice-100" class="bg-black/40 px-2 py-1 rounded" /></label>
            </div>
            <div class="mt-2 p-2 rounded bg-white/5">
              <div class="font-semibold mb-1">Адрес бэкенда (опционально)</div>
              <label class="grid gap-1"><span class="text-xs">URL сервера (пример: https://abc.ngrok-free.app)</span><input id="donate-backend" class="bg-black/40 px-2 py-1 rounded" /></label>
              <label class="mt-1 inline-flex items-center gap-2 text-sm"><input id="donate-use-backend" type="checkbox" class="scale-110" /><span>Получать ссылки с сервера</span></label>
            </div>
            <div class="flex gap-2 mt-2">
              <button id="donate-settings-save" class="px-3 py-2 rounded bg-emerald-500/80 hover:bg-emerald-500 text-white text-sm font-semibold">Сохранить</button>
              <button id="donate-settings-clear" class="px-3 py-2 rounded bg-red-500/70 hover:bg-red-500 text-white text-sm font-semibold">Очистить</button>
            </div>
            <p class="text-[11px] text-white/60">Stars: <code>currency: "XTR"</code>, <code>provider_token: ""</code> (пусто). С сервером игра вызывает <code>GET /invoice?amount=10|50|100</code>.</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="tg-add-10" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white font-semibold">+10 ⭐ (тест локально)</button>
          <button id="tg-reset" class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-white font-semibold">Сбросить</button>
        </div>
        <p class="text-xs text-white/70">⭐ копятся локально и независимы от 💵. В Telegram Mini App кнопки откроют инвойсы через <code>WebApp.openInvoice</code>.</p>
      </div>
    </section>

    <footer id="bottombar" class="w-full bg-black/45 p-2 rounded-2xl mt-2">
      <nav class="flex justify-around items-end">
        <button class="tab-btn flex flex-col items-center text-center text-white/90 hover:text-white transition-colors" data-screen="screen-income" aria-selected="false">
          <div class="p-3 bg-yellow-500/20 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-300">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <span class="text-xs mt-1">Доход</span>
        </button>
        <button class="tab-btn flex flex-col items-center text-center text-white/90 hover:text-white transition-colors" data-screen="screen-upgrades" aria-selected="false">
          <div class="p-3 bg-blue-500/20 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-300">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </div>
          <span class="text-xs mt-1">Улучшения</span>
        </button>
        <button class="tab-btn flex flex-col items-center text-center text-white/90 hover:text-white transition-colors" data-screen="screen-game" aria-selected="false">
          <div class="p-3 bg-amber-500/20 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-300">
              <rect x="3" y="4" width="18" height="16" rx="3"/><path d="M8 4v16M16 4v16"/>
            </svg>
          </div>
          <span class="text-xs mt-1">Игра</span>
        </button>
        <button class="tab-btn flex flex-col items-center text-center text-white/90 hover:text-white transition-colors" data-screen="screen-skins" aria-selected="false">
          <div class="p-3 bg-emerald-500/20 rounded-lg"><span class="text-2xl leading-none">🐾</span></div>
          <span class="text-xs mt-1">Скины</span>
        </button>
        <button class="tab-btn flex flex-col items-center text-center text-white/90 hover:text-white transition-colors" data-screen="screen-donates" aria-selected="false">
          <div class="p-3 bg-purple-500/20 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-300">
              <polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9 12 2"/>
            </svg>
          </div>
          <span class="text-xs mt-1">Донаты</span>
        </button>
      </nav>
    </footer>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Фикс динамических переменных компоновки
  const rootStyle = document.documentElement.style;
  function updateLayoutVars(){
    const header=document.getElementById('topbar');
    const footer=document.getElementById('bottombar');
    const hh = header ? Math.ceil(header.getBoundingClientRect().height) : 56;
    const fh = footer ? Math.ceil(footer.getBoundingClientRect().height) : 88;
    rootStyle.setProperty('--header-h', hh+'px');
    rootStyle.setProperty('--footer-h', fh+'px');

    const wrap=document.getElementById('wrapper');
    const w = wrap.clientWidth;
    const h = wrap.clientHeight;
    const size = Math.max(220, Math.min(420, Math.min(w*0.82, (h - hh - fh) * 0.52)));
    rootStyle.setProperty('--stage-size', Math.round(size)+'px');
  }
  updateLayoutVars();
  const roH = new ResizeObserver(updateLayoutVars);
  const roF = new ResizeObserver(updateLayoutVars);
  document.getElementById('topbar') && roH.observe(document.getElementById('topbar'));
  document.getElementById('bottombar') && roF.observe(document.getElementById('bottombar'));
  window.addEventListener('resize', updateLayoutVars);

  // --- Прелоадер-сторож дубль ---
  (function(){
    var p=document.getElementById('preloader'); if(!p) return;
    var hid=false; function hide(){ if(hid) return; hid=true; try{ p.classList.add('hidden') }catch(_){ } }
    window.addEventListener('load', hide, {once:true});
    setTimeout(hide, 7000);
  })();

  const SAVE_KEY='clicker_save_v4'; // сохраняем совместимость
  let stars=0, xp=0, energy=100, maxEnergy=100, perClick=1, regenPerSec=1;
  let telegramStars=0;
  let priceMax=30, priceRegen=25;

  // НОВОЕ: уровень игрока и счётчик покупок +1-к-деньгам
  const MAX_LEVEL=7;
  let playerLevel=1;
  let clickUpgradeCount=0; // сколько раз куплен «+1 к деньгам»

  // Цена апгрейда «+1 к деньгам»: 500, 800, 1100, далее +300 за каждый следующий
  function clickUpgradePrice(){ return 500 + clickUpgradeCount*300; }
  function canBuyClickUpgrade(){
    // До 5 уровня максимум 3 покупки
    if (playerLevel < 5 && clickUpgradeCount >= 3) return false;
    return true;
  }

  // Цена следующего уровня: (текущий+1)*300; после 7 уровня — нет следующего
  function nextLevelCost(){
    if (playerLevel >= MAX_LEVEL) return null;
    const next = playerLevel + 1;
    return next * 300;
  }

  const SKIN_PRICE=10;

  const CHARACTER_SKINS=[
    {key:'knight',name:'Рыцарь',img:'https://i.postimg.cc/tC2PZ2S3/1755819166-Photoroom.png'},
    {key:'jojo',name:'JoJo',img:'https://i.postimg.cc/RZYHGqzq/1755820156-Photoroom.png'},
    {key:'naruto',name:'Наруто',img:'https://i.postimg.cc/VLYnk3Rs/1755820818-Photoroom.png'},
    {key:'clown',name:'Клоун',img:'https://i.postimg.cc/RZhtcKyj/Chat-GPT-Image-22-2025-02-10-48-Photoroom.png'},
    {key:'kek',name:'КеК',img:'https://i.postimg.cc/JhBBFm1x/shrek.png'}
  ];
  const DOG_URL='https://i.postimg.cc/76NmJx8X/dog.png';
  let ownedSkins={}; let activePet=''; let activeSkin='';

  // ====== АУДИО ======
  const bgm=document.getElementById('bgm');
  const sfxClick=document.getElementById('sfx-click');
  const settingsBtn=document.getElementById('settings-btn');
  const settingsPanel=document.getElementById('settings-panel');
  const volMusic=document.getElementById('vol-music');
  const volSfx=document.getElementById('vol-sfx');
  const AUDIO_KEY='audio_prefs_v4';
  let audioPrefs={musicVol:0.1,sfxVol:0.8,musicOn:true};
  try{const raw=localStorage.getItem(AUDIO_KEY);if(raw){audioPrefs={...audioPrefs,...JSON.parse(raw)}}}catch(_){ }
  if(volMusic)volMusic.value=String(audioPrefs.musicVol);
  if(volSfx)volSfx.value=String(audioPrefs.sfxVol);
  if(bgm){bgm.volume=audioPrefs.musicVol}
  if(sfxClick){sfxClick.volume=audioPrefs.sfxVol}
  function saveAudio(){try{localStorage.setItem(AUDIO_KEY,JSON.stringify(audioPrefs))}catch(_){}}

  bgm?.addEventListener('error',()=>{console.warn('Не удалось загрузить музыку по пути:', bgm.currentSrc || bgm.src)});
  sfxClick?.addEventListener('error',()=>{console.warn('Не удалось загрузить звук клика по пути:', sfxClick.currentSrc || sfxClick.src)});

  const AudioCtx=window.AudioContext||window.webkitAudioContext;
  let actx=null,master=null,bgmGain=null,sfxGain=null,bgmNode=null,sfxBuf=null;

  async function initAudioOnce(){
    if(!AudioCtx) return;
    if(!actx){actx=new AudioCtx();master=actx.createGain();master.gain.value=1;master.connect(actx.destination)}
    if(!bgmGain){bgmGain=actx.createGain();bgmGain.gain.value=audioPrefs.musicVol;bgmGain.connect(master)}
    if(!sfxGain){sfxGain=actx.createGain();sfxGain.gain.value=audioPrefs.sfxVol;sfxGain.connect(master)}
    if(bgm&&!bgmNode){try{bgmNode=actx.createMediaElementSource(bgm);bgmNode.connect(bgmGain);bgm.volume=1}catch(e){}}
    if(!sfxBuf && sfxClick && sfxClick.src){
      try{
        const r=await fetch(sfxClick.src,{cache:'force-cache'});
        const arr=await r.arrayBuffer();
        sfxBuf=await actx.decodeAudioData(arr);
      }catch(e){console.warn('SFX decode error для', sfxClick.src, e)}
    }
  }
  async function maybeStartBgm(){ if(!bgm || !bgm.src) return; if(audioPrefs.musicOn&&bgm.paused){ try{await bgm.play()}catch(_){}} }
  async function unlockAudio(){
    if(!AudioCtx){ await maybeStartBgm(); return }
    await initAudioOnce();
    if(actx&&actx.state==='suspended'){ try{await actx.resume()}catch(_){} }
    await maybeStartBgm();
  }
  ['pointerdown','touchstart','keydown'].forEach(ev=>document.addEventListener(ev,unlockAudio,{passive:true}));

  function setMusicVol(v){ v=Math.min(1,Math.max(0,+v||0)); audioPrefs.musicVol=v; if(bgmGain)bgmGain.gain.value=v; if(bgm&&!bgmGain)bgm.volume=v; saveAudio() }
  function setSfxVol(v){ v=Math.min(1,Math.max(0,+v||0)); audioPrefs.sfxVol=v; if(sfxGain)sfxGain.gain.value=v; if(sfxClick&&!sfxGain)sfxClick.volume=v; saveAudio() }
  const _readVol=el=>Math.min(1,Math.max(0,parseFloat(el?.value||'0')));
  ['input','change'].forEach(evt=>{
    volMusic?.addEventListener(evt,()=>setMusicVol(_readVol(volMusic)));
    volSfx?.addEventListener(evt,()=>setSfxVol(_readVol(volSfx)));
  });
  settingsBtn?.addEventListener('click',()=>settingsPanel?.classList.toggle('hidden'));

  // ===== Хаптик и подписки =====
  const tg=window.Telegram&&window.Telegram.WebApp?window.Telegram.WebApp:null;
  function hapticTap(){ try{ tg?.HapticFeedback?.impactOccurred?.('light') }catch(_){ } try{ navigator?.vibrate?.(10) }catch(_){ } }
  document.getElementById('spinBtn')?.addEventListener('click',hapticTap);
  document.getElementById('rocketStart')?.addEventListener('click',hapticTap);
  document.getElementById('rocketCashout')?.addEventListener('click',hapticTap);
  document.getElementById('character')?.addEventListener('pointerdown',hapticTap,{passive:true});
  function openChannel(url){ try{ if(tg && typeof tg.openTelegramLink==='function'){ tg.openTelegramLink(url); } else { window.open(url,'_blank'); } }catch(_){ window.open(url,'_blank'); } }
  document.getElementById('sub-open')?.addEventListener('click',()=>openChannel('https://t.me/vers_diz'));
  document.getElementById('sub-open-2')?.addEventListener('click',()=>openChannel('https://t.me/Ugly_Studio'));

  // ===== Ассеты =====
  const BG_BY_LEVEL=[
    'https://i.postimg.cc/bYC9rVNc/Chat-GPT-Image-16-2025-17-40-13.png',
    'https://i.postimg.cc/yxDKJ5Tx/Chat-GPT-Image-18-2025-03-14-02.png',
    'https://i.postimg.cc/CKj0fd2f/Chat-GPT-Image-17-2025-01-38-13.png',
    'https://i.postimg.cc/3JD7YsRb/image.png',
    'https://i.postimg.cc/br4h1T6T/be0fa4b1-51fa-428b-9ad8-341d140dc290.png',
    'https://i.postimg.cc/ZYQ4kbTd/image.png',
    'https://i.postimg.cc/mDXRgRCK/Chat-GPT-Image-18-2025-04-38-22.png'
  ];
  const CHAR_BY_LEVEL=[
    'https://i.postimg.cc/zXWCKfvw/image.png',
    'https://i.postimg.cc/8CkM2BHw/image.png',
    'https://i.postimg.cc/jqDQqcrF/image.png',
    'https://i.postimg.cc/XYk91Dwp/image.png',
    'https://i.postimg.cc/yNfcsgpK/image.png',
    'https://i.postimg.cc/y62hDR1Y/image.png',
    'https://i.postimg.cc/XXMvn404/image.png'
  ];
  const INTRO_VERA='https://i.postimg.cc/rwFbVPMr/vera-1-Photoroom.png';
  function assetByLevelClamp(arr,lvl){ const i=Math.min(arr.length-1,Math.max(1,lvl)-1); return arr[i] }

  // ===== Сохранение/загрузка =====
  function saveState(){
    const p={
      stars,xp,energy,maxEnergy,perClick,regenPerSec,
      telegramStars,priceMax,priceRegen,
      ownedSkins,activePet,activeSkin,
      playerLevel,clickUpgradeCount,
      ts:Date.now()
    };
    try{localStorage.setItem(SAVE_KEY,JSON.stringify(p))}catch(e){}
  }
  let _saveTimer=null,_saveAgain=false;
  function queueSave(immediate=false){
    if(immediate){ saveState(); return }
    if(_saveTimer){ _saveAgain=true; return }
    _saveTimer=setTimeout(()=>{ saveState(); _saveTimer=null; if(_saveAgain){ _saveAgain=false; queueSave() } },380);
  }
  window.addEventListener('pagehide',()=>queueSave(true));
  function loadState(){
    try{
      const raw=localStorage.getItem(SAVE_KEY);
      if(raw){
        const d=JSON.parse(raw);
        if(typeof d.stars==='number')stars=d.stars;
        // Миграция: если playerLevel не сохранён, вычисляем из старого xp
        if (typeof d.playerLevel==='number') playerLevel=d.playerLevel;
        else if (typeof d.xp==='number') playerLevel=Math.max(1,Math.min(MAX_LEVEL, Math.floor(d.xp/200)+1));
        energy=d.energy??energy; maxEnergy=d.maxEnergy??maxEnergy;
        perClick=d.perClick??perClick; regenPerSec=d.regenPerSec??regenPerSec;
        telegramStars=typeof d.telegramStars==='number'?d.telegramStars:telegramStars;
        priceMax=d.priceMax??priceMax; priceRegen=d.priceRegen??priceRegen;
        ownedSkins=d.ownedSkins&&typeof d.ownedSkins==='object'?d.ownedSkins:{};
        activePet=typeof d.activePet==='string'?d.activePet:'';
        activeSkin=typeof d.activeSkin==='string'?d.activeSkin:'';
        clickUpgradeCount = typeof d.clickUpgradeCount==='number' ? d.clickUpgradeCount : Math.max(0,(perClick|0)-1);
        const secs=d.ts?Math.max(0,Math.floor((Date.now()-d.ts)/1000)):0;
        energy=Math.min(maxEnergy,energy+secs*regenPerSec);
      }
    }catch(e){}
  }
  loadState();

  // ===== UI =====
  const wrapper=document.getElementById('wrapper');
  const gameRoot=document.getElementById('game');
  const character=document.getElementById('character');
  const levelEl=document.getElementById('level');
  const lvlCaption=document.getElementById('lvl-caption');
  const lvlProgressText=document.getElementById('lvl-progress');
  const lvlProgressBar=document.getElementById('lvl-progress-bar');
  const buyLevelBtn=document.getElementById('buy-level');
  const levelCostSpan=document.getElementById('level-cost');

  const scoreDisplay=document.getElementById('score');
  const scoreBig=document.getElementById('score-big');
  const energyBar=document.getElementById('energy-bar');
  const energyLevelDisplay=document.getElementById('energy-level');
  const maxEnergyDisplay=document.getElementById('max-energy');
  const statPerClick=document.getElementById('stat-per-click');
  const statRegen=document.getElementById('stat-regen');
  const statMaxEnergy=document.getElementById('stat-max-energy');
  const btnBuyClick=document.getElementById('buy-click');
  const btnBuyMax=document.getElementById('buy-max');
  const btnBuyRegen=document.getElementById('buy-regen');
  const costClick=document.getElementById('cost-click');
  const costMax=document.getElementById('cost-max');
  const costRegen=document.getElementById('cost-regen');
  const resetBtn=document.getElementById('reset-progress');
  const bg=document.getElementById('bg');
  const tgStarsBalance=document.getElementById('tg-stars-balance');
  const tgAdd10=document.getElementById('tg-add-10');
  const tgReset=document.getElementById('tg-reset');
  const intro=document.getElementById('intro');
  const introStart=document.getElementById('intro-start');
  const petDog=document.getElementById('pet-dog');

  function openIntro(){ if(!intro) return; intro.classList.add('show'); intro.setAttribute('aria-hidden','false') }
  function closeIntro(){ if(!intro) return; intro.classList.remove('show'); intro.setAttribute('aria-hidden','true') }
  introStart?.addEventListener('click',closeIntro);
  window.showIntro=openIntro;

  const currentLevel = ()=> playerLevel;

  function characterSrcBySkin(){
    if(activeSkin&&ownedSkins[activeSkin]){
      const f=CHARACTER_SKINS.find(s=>s.key===activeSkin); if(f) return f.img;
    }
    return '';
  }
  function refreshCharacterByLevel(){
    const skinSrc=characterSrcBySkin();
    const need=skinSrc||assetByLevelClamp(CHAR_BY_LEVEL,currentLevel());
    if(character.getAttribute('src')!==need) character.setAttribute('src',need);
  }
  function refreshBackgroundByLevel(){
    const need=assetByLevelClamp(BG_BY_LEVEL,currentLevel());
    if(bg.getAttribute('src')!==need) bg.setAttribute('src',need);
  }

  function refreshLevelUI(){
    levelEl.textContent=String(currentLevel());

    const cost = nextLevelCost();
    if (cost === null){
      // максимум
      lvlProgressText.textContent = 'макс.';
      lvlCaption.textContent = 'Макс. уровень';
      lvlProgressBar.style.width='100%';
      buyLevelBtn.classList.add('hidden');
    } else {
      // показать прогресс накопления к цене
      const have = Math.max(0, stars|0);
      lvlProgressText.textContent = `${Math.min(have,cost)} / ${cost}`;
      const ratio = Math.max(0, Math.min(1, have / cost));
      lvlProgressBar.style.width = (ratio*100)+'%';
      levelCostSpan.textContent = String(cost);
      buyLevelBtn.disabled = have < cost;
      buyLevelBtn.classList.remove('hidden');
    }
  }

  function updatePet(){
    if(activePet==='dog'&&ownedSkins['dog']){
      if(petDog){petDog.src=DOG_URL; petDog.classList.add('show')}
    }else{ petDog?.classList.remove('show') }
  }
  function refreshUI(){
    refreshLevelUI();
    refreshCharacterByLevel();
    refreshBackgroundByLevel();

    scoreDisplay.textContent=stars;
    scoreBig.textContent=stars;
    if(tgStarsBalance)tgStarsBalance.textContent=telegramStars+' ⭐';
    energyLevelDisplay.textContent=Math.floor(energy);
    if(maxEnergyDisplay)maxEnergyDisplay.textContent=maxEnergy;
    energyBar.style.width=(energy/maxEnergy*100)+'%';
    if(statPerClick)statPerClick.textContent=perClick;
    if(statRegen)statRegen.textContent=regenPerSec;
    if(statMaxEnergy)statMaxEnergy.textContent=maxEnergy;

    // Апгрейд «+1 к деньгам»
    const priceC = clickUpgradePrice();
    if (costClick) costClick.textContent = String(priceC);
    if (btnBuyClick){
      btnBuyClick.disabled = !canBuyClickUpgrade();
      btnBuyClick.title = btnBuyClick.disabled ? 'Откроется после достижения 5 уровня' : '';
    }

    if(costMax)costMax.textContent=priceMax;
    if(costRegen)costRegen.textContent=priceRegen;

    renderSkinsUI();
    updatePet();
  }

  // Аним. монеты
  let wrapperRect=wrapper.getBoundingClientRect();
  function updateWrapperRect(){ wrapperRect=wrapper.getBoundingClientRect() }
  window.addEventListener('resize',updateWrapperRect,{passive:true});
  window.addEventListener('scroll',updateWrapperRect,{passive:true});
  const COIN_POOL=12; const coinPool=[]; let coinPtr=0;
  for(let i=0;i<COIN_POOL;i++){
    const el=document.createElement('div');
    el.className='floating-coin';
    el.innerHTML='<span class="coin-text">+1<\/span> <span class="font-extrabold">💵<\/span>';
    wrapper.appendChild(el); coinPool.push(el);
  }
  function animateCoin(el,x,y,val){
    el.querySelector('.coin-text').textContent='+'+val;
    el.style.setProperty('--x',(x|0)+'px');
    el.style.setProperty('--y',(y|0)+'px');
    el.style.animation='none'; void el.offsetWidth;
    el.style.animation='floatUp 1s ease-out forwards';
  }
  function showFloatingCoin(evt){
    const cx=(evt.clientX||(evt.touches&&evt.touches[0].clientX))-wrapperRect.left;
    const cy=(evt.clientY||(evt.touches&&evt.touches[0].clientY))-wrapperRect.top-20;
    const el=coinPool[coinPtr++%COIN_POOL];
    animateCoin(el,cx+(Math.random()*24-12),cy,perClick);
  }
  function gainStars(a){ stars+=a; /* XP больше не используется для уровня */ }

  // Клик по персонажу
  function playClickSfx(){
    const now=performance.now();
    if(playClickSfx._t&&now-playClickSfx._t<70) return;
    playClickSfx._t=now;
    if(sfxBuf&&actx){
      try{
        const src=actx.createBufferSource(); src.buffer=sfxBuf;
        const g=actx.createGain(); const v=audioPrefs.sfxVol;
        g.gain.setValueAtTime(0,actx.currentTime);
        g.gain.linearRampToValueAtTime(v,actx.currentTime+0.015);
        src.connect(g).connect(sfxGain||master);
        src.start(); src.stop(actx.currentTime+0.25); return;
      }catch(e){}
    }
    try{ if(sfxClick && sfxClick.src){ sfxClick.currentTime=0; sfxClick.volume=audioPrefs.sfxVol; sfxClick.play() } }catch(e){}
  }
  function onClickCharacter(e){
    if(energy>=1){
      playClickSfx();
      gainStars(perClick);
      energy-=1;
      showFloatingCoin(e);
      refreshUI();
      queueSave();
    }
  }
  function pressDown(){character.classList.add('pressed')}
  function pressUp(){character.classList.remove('pressed')}
  character.addEventListener('mousedown',e=>{pressDown();onClickCharacter(e)});
  character.addEventListener('mouseup',pressUp);
  character.addEventListener('mouseleave',pressUp);
  character.addEventListener('touchstart',e=>{e.preventDefault();pressDown();onClickCharacter(e)},{passive:false});
  character.addEventListener('touchend',pressUp);
  character.addEventListener('touchcancel',pressUp);

  // Реген энергии
  setInterval(()=>{ if(energy<maxEnergy){ energy+=regenPerSec/2; if(energy>maxEnergy)energy=maxEnergy; refreshUI() } },500);

  // ===== Навигация/экраны =====
  const tabButtons=[...document.querySelectorAll('.tab-btn')];
  const screens={ income:document.getElementById('screen-income'), upgrades:document.getElementById('screen-upgrades'), game:document.getElementById('screen-game'), skins:document.getElementById('screen-skins'), donates:document.getElementById('screen-donates') };
  function hideAllScreens(){ Object.values(screens).forEach(el=>{ if(el){ el.classList.remove('active'); el.setAttribute('aria-hidden','true') } }); gameRoot.classList.remove('scene-dim'); }
  function setActiveBtn(btn){ tabButtons.forEach(b=>b.setAttribute('aria-selected','false')); if(btn) btn.setAttribute('aria-selected','true') }
  function openScreenById(id){ hideAllScreens(); const el=document.getElementById(id); if(el){ el.classList.add('active'); el.setAttribute('aria-hidden','false'); gameRoot.classList.add('scene-dim') } }
  function closeScreens(){ hideAllScreens(); setActiveBtn(null) }
  tabButtons.forEach(btn=>btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-screen'); const el=document.getElementById(id); const opened=el&&el.classList.contains('active'); if(opened){ closeScreens() } else { openScreenById(id); setActiveBtn(btn) } }));
  document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',closeScreens));

  // Закрытия панелей по клику вне
  document.addEventListener('pointerdown',(e)=>{
    const t=e.target;
    const hasOpen=Object.values(screens).some(el=>el&&el.classList.contains('active'));
    if(hasOpen && !t.closest('.screen') && !t.closest('.tab-btn')){ closeScreens(); }
    if(settingsPanel && !settingsPanel.classList.contains('hidden')){
      const inside=settingsPanel.contains(t);
      const onBtn=(t===settingsBtn)||(settingsBtn&&settingsBtn.contains(t));
      if(!inside&&!onBtn){ settingsPanel.classList.add('hidden') }
    }
    const paytable=document.getElementById('paytable');
    const payBtn=document.getElementById('paytableBtn');
    if(paytable && !paytable.classList.contains('hidden')){
      const inside=paytable.contains(t);
      const onBtn=(t===payBtn)||(payBtn&&payBtn.contains(t));
      if(!inside&&!onBtn){ paytable.classList.add('hidden') }
    }
    const donatePanel=document.getElementById('donate-settings');
    const donateTgl=document.getElementById('donate-settings-toggle');
    if(donatePanel && !donatePanel.classList.contains('hidden')){
      const inside=donatePanel.contains(t);
      const onBtn=(t===donateTgl)||(donateTgl&&donateTgl.contains(t));
      if(!inside&&!onBtn){ donatePanel.classList.add('hidden') }
    }
  });

  // ===== Магазин уровней (покупка) =====
  buyLevelBtn?.addEventListener('click',()=>{
    const cost = nextLevelCost();
    if (cost===null) return;
    if (stars < cost) return;
    stars -= cost;
    playerLevel = Math.min(MAX_LEVEL, playerLevel + 1);
    refreshUI();
    queueSave(true);
  });

  // ===== Магазин апгрейдов =====
  function tryBuy(cost){ if(stars>=cost){ stars-=cost; refreshUI(); queueSave(); return true } return false }

  // «+1 к деньгам»
  btnBuyClick?.addEventListener('click',()=>{
    if(!canBuyClickUpgrade()){
      alert('Доступно после достижения 5 уровня');
      return;
    }
    const price = clickUpgradePrice();
    if(tryBuy(price)){
      perClick += 1;
      clickUpgradeCount += 1;
      refreshUI();
      queueSave(true);
    }
  });

  // Остальные апгрейды — как было
  btnBuyMax?.addEventListener('click',()=>{ if(tryBuy(priceMax)){ maxEnergy+=10; energy=Math.min(maxEnergy,energy+10); priceMax=Math.ceil(priceMax*1.6); refreshUI(); queueSave(true) } });
  btnBuyRegen?.addEventListener('click',()=>{ if(tryBuy(priceRegen)){ regenPerSec=Math.round((regenPerSec+0.5)*10)/10; priceRegen=Math.ceil(priceRegen*1.6); refreshUI(); queueSave(true) } });

  resetBtn?.addEventListener('click',()=>{
    stars=0; xp=0; energy=100; maxEnergy=100; perClick=1; regenPerSec=1;
    priceMax=30; priceRegen=25;
    ownedSkins={}; activePet=''; activeSkin='';
    playerLevel=1; clickUpgradeCount=0;
    try{localStorage.removeItem(SAVE_KEY)}catch(e){}
    refreshUI(); queueSave(true);
  });

  // ===== Донаты Stars =====
  const LINKS_KEY='donate_links_v1';
  function loadLinks(){ try{const raw=localStorage.getItem(LINKS_KEY); return raw?JSON.parse(raw):{} }catch(e){ return {} } }
  function saveLinks(obj){ try{localStorage.setItem(LINKS_KEY,JSON.stringify(obj||{}))}catch(e){} }
  const BACKEND_URL_KEY='donate_backend_url_v1';
  const USE_BACKEND_KEY='donate_use_backend_v1';
  const settingsToggle=document.getElementById('donate-settings-toggle');
  const settingsPanelDonate=document.getElementById('donate-settings');
  const input10=document.getElementById('invoice-10');
  const input50=document.getElementById('invoice-50');
  const input100=document.getElementById('invoice-100');
  const inputBackend=document.getElementById('donate-backend');
  const inputUseBackend=document.getElementById('donate-use-backend');
  const settingsSave=document.getElementById('donate-settings-save');
  const settingsClear=document.getElementById('donate-settings-clear');
  const donateLinks=loadLinks();
  if(input10)input10.value=donateLinks['10']||'';
  if(input50)input50.value=donateLinks['50']||'';
  if(input100)input100.value=donateLinks['100']||'';
  if(inputBackend)inputBackend.value=localStorage.getItem(BACKEND_URL_KEY)||'';
  if(inputUseBackend)inputUseBackend.checked=(localStorage.getItem(USE_BACKEND_KEY)==='1');
  settingsToggle?.addEventListener('click',()=>{settingsPanelDonate.classList.toggle('hidden')});
  settingsSave?.addEventListener('click',()=>{ const obj={'10':(input10?.value||'').trim(),'50':(input50?.value||'').trim(),'100':(input100?.value||'').trim(),}; saveLinks(obj); if(inputBackend){localStorage.setItem(BACKEND_URL_KEY,(inputBackend.value||'').trim())} if(inputUseBackend){localStorage.setItem(USE_BACKEND_KEY,inputUseBackend.checked?'1':'0')} alert('Настройки донатов сохранены.'); });
  settingsClear?.addEventListener('click',()=>{ saveLinks({}); if(input10)input10.value=''; if(input50)input50.value=''; if(input100)input100.value=''; if(inputBackend){inputBackend.value=''; localStorage.removeItem(BACKEND_URL_KEY)} if(inputUseBackend){inputUseBackend.checked=false; localStorage.removeItem(USE_BACKEND_KEY)} alert('Ссылки и настройки сервера очищены.'); });
  function openStarsInvoice(amount){
    const useBackend=(localStorage.getItem(USE_BACKEND_KEY)==='1');
    const backendUrl=(localStorage.getItem(BACKEND_URL_KEY)||'').trim();
    const manualUrl=(loadLinks()[String(amount)]||'').trim();
    const tryServer=async()=>{
      if(!useBackend||!backendUrl) return '';
      try{
        const base=backendUrl.replace(/\/$/,'');
        const r=await fetch(`${base}/invoice?amount=${encodeURIComponent(amount)}`);
        const data=await r.json().catch(()=>({}));
        if(data&&typeof data.result==='string')return data.result;
        if(typeof data==='string')return data;
        return '';
      }catch(e){console.warn('Сервер недоступен',e); return ''}
    };
    (async()=>{
      let url=await tryServer(); if(!url)url=manualUrl;
      if(!url){ alert('Нет ссылки на инвойс для '+amount+'⭐. Заполни в настройках или укажи URL сервера.'); return }
      if(tg&&typeof tg.openInvoice==='function'){
        try{
          tg.openInvoice(url,(status)=>{
            if(status==='paid'){ telegramStars+=amount; refreshUI(); queueSave(true); if(tg.showAlert)tg.showAlert('Спасибо! Оплачено: +'+amount+'⭐') }
            else if(status==='cancelled'){ if(tg.showAlert)tg.showAlert('Платёж отменён') }
            else if(status==='failed'){ if(tg.showAlert)tg.showAlert('Ошибка платежа') }
          });
        }catch(err){ console.error(err); alert('Не удалось открыть инвойс в Telegram.') }
      } else {
        window.open(url,'_blank');
      }
    })();
  }
  document.querySelectorAll('.donate-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{ const amt=parseInt(btn.getAttribute('data-amt'),10)||0; if(amt>0)openStarsInvoice(amt) });
  });
  tgAdd10?.addEventListener('click',()=>{telegramStars+=10;refreshUI();queueSave(true)});
  tgReset?.addEventListener('click',()=>{telegramStars=0;refreshUI();queueSave(true)});
  if(tg&&typeof tg.onEvent==='function'){ tg.onEvent('invoiceClosed',(obj)=>{console.log('invoiceClosed:',obj)}) }

  // ===== СЛОТЫ =====
  const SPIN_COST=5,COOLDOWN_MS=900;
  const symbols=[
    {emoji:'🍒',weight:24,payout3:15},
    {emoji:'🍋',weight:20,payout3:20},
    {emoji:'🍉',weight:14,payout3:40},
    {emoji:'🍇',weight:10,payout3:60},
    {emoji:'🍀',weight:16,payout3:30},
    {emoji:'🍑',weight:12,payout3:35},
    {emoji:'7️⃣',weight:4,payout3:250}
  ];
  const reelsEls=[document.getElementById('reel0'),document.getElementById('reel1'),document.getElementById('reel2')];
  const spinBtn=document.getElementById('spinBtn');
  const paytable=document.getElementById('paytable');
  const paytableBtn=document.getElementById('paytableBtn');
  const cooldownText=document.getElementById('cooldownText');
  const winBanner=document.getElementById('slotsWinBanner');
  paytableBtn?.addEventListener('click',()=>{paytable.classList.toggle('hidden')});

  const CELL_H=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||88;
  const LOOPS=8;
  const reels=reelsEls.map(el=>({el,arr:[],current:0}));
  function shuffle(a){ for(let n=a.length-1;n>0;n--){ const j=Math.floor(Math.random()*(n+1)); [a[n],a[j]]=[a[j],a[n]] } }
  function buildReel(data){
    const baseSymbols = symbols.map(s => s.emoji);
    const reelContent = [];
    for (let i = 0; i < LOOPS * 2; i++) { shuffle(baseSymbols); reelContent.push(...baseSymbols); }
    data.arr = reelContent;
    data.el.innerHTML = reelContent.map(e => `<div class='cell'>${e}</div>`).join('');
    data.current = 0;
    data.el.style.transition = 'none';
    data.el.style.transform = 'translateY(0px)';
  }
  reels.forEach(buildReel);
  function weightedPickIdx(){
    const total=symbols.reduce((a,s)=>a+s.weight,0);
    let r=Math.random()*total;
    for(let i=0;i<symbols.length;i++){ r-=symbols[i].weight; if(r<=0) return i }
    return symbols.length-1;
  }
  function capReel(data){ if(data.arr.length>300){ data.current=0; buildReel(data) } }
  function ensureTargetIndex(data,symbol,start){
    let idx=data.arr.indexOf(symbol,start);
    if(idx!==-1) return idx;
    const extra=[]; for(let k=0;k<symbols.length*3;k++){ extra.push(symbols[k%symbols.length].emoji) } extra.push(symbol);
    data.arr.push(...extra);
    const frag=document.createDocumentFragment();
    extra.forEach(e=>{ const d=document.createElement('div'); d.className='cell'; d.textContent=e; frag.appendChild(d) });
    data.el.appendChild(frag);
    capReel(data);
    return data.arr.length-1;
  }
  function outcomePay(a,b,c){
    if(a===b&&b===c){ const s=symbols.find(x=>x.emoji===a); return s?s.payout3:0 }
    if(a===b||a===c||b===c){ const two7=[a,b,c].filter(x=>x==='7️⃣').length===2; return two7?40:5 }
    return 0;
  }
  function showWin(val){
    if(val<=0) return;
    winBanner.textContent='+0 💵';
    winBanner.classList.add('show');
    let start=performance.now();
    const base=260+Math.min(440,val*6);
    function step(ts){
      const p=Math.min(1,(ts-start)/base);
      const cur=Math.round(val*p);
      winBanner.textContent=`+${cur} 💵`;
      if(p<1){ requestAnimationFrame(step) } else { setTimeout(()=>winBanner.classList.remove('show'),900) }
    }
    requestAnimationFrame(step);
  }

  let spinning=false,lastSpin=0;
  function spin(){
    if(spinning) return;
    const now=Date.now();
    if(now-lastSpin<COOLDOWN_MS){ cooldownText.textContent='Подождите…'; return }
    if(stars<SPIN_COST){ cooldownText.textContent='Нужно 5 💵'; return }
    stars-=SPIN_COST; refreshUI(); queueSave();
    spinning=true; lastSpin=now; cooldownText.textContent='Крутится…';
    const targets=[weightedPickIdx(),weightedPickIdx(),weightedPickIdx()].map(i=>symbols[i].emoji);
    const durations=[],finalIdx=[],res=[];
    reels.forEach((data,ri)=>{
      const turnsBase=24+ri*8;
      const jitter=Math.floor(Math.random()*symbols.length);
      const start=data.current+turnsBase+jitter;
      const tIdx=ensureTargetIndex(data,targets[ri],start);
      finalIdx[ri]=tIdx; res[ri]=targets[ri];
      const dur=1.0+ri*0.2; durations[ri]=dur;
      data.el.style.transition='none';
      data.el.style.transform=`translateY(${-data.current*CELL_H}px)`;
      requestAnimationFrame(()=>{
        data.el.style.transition=`transform ${dur}s cubic-bezier(.12,.68,.08,1)`;
        data.el.style.transform=`translateY(${-tIdx*CELL_H}px)`;
      });
    });
    const totalTime=Math.max(...durations)*1000+120;
    setTimeout(()=>{
      reels.forEach((d,i)=>d.current=finalIdx[i]);
      const gain=outcomePay(res[0],res[1],res[2]);
      if(gain>0){ gainStars(gain); showWin(gain) }
      refreshUI(); queueSave();
      spinning=false; cooldownText.textContent='Готово к спину';
    }, totalTime);
  }
  spinBtn?.addEventListener('click',spin);

  // ===== РАКЕТА =====
  const rocketSprite=document.getElementById('rocketSprite');
  const rocketMultEl=document.getElementById('rocketMult');
  const rocketStartBtn=document.getElementById('rocketStart');
  const rocketCashoutBtn=document.getElementById('rocketCashout');
  const rocketBetInput=document.getElementById('rocketBet');
  const rocketAutoInput=document.getElementById('rocketAuto');
  const rocketBanner=document.getElementById('rocketBanner');
  const rocketSky=document.querySelector('.rocket-sky');
  const rocketCurve=document.getElementById('rocketCurve');
  const rBetPlus=document.getElementById('rBetPlus');
  const rBetMinus=document.getElementById('rBetMinus');
  const rAuto2=document.getElementById('rAuto2');
  const rAuto3=document.getElementById('rAuto3');
  let rState='idle'; let rBet=0; let rStart=0; let rCrashAt=0; let rReq=0; let rMult=1.0;

  function stopRocketLoop(){ if(rReq){ cancelAnimationFrame(rReq); rReq=0 } }
  function clamp(v,min,max){ return Math.max(min,Math.min(max,v)) }
  function rReset(){
    stopRocketLoop(); rState='idle'; rBet=0; rMult=1.0;
    rocketMultEl.textContent='x1.00';
    rocketSprite.classList.remove('shake','boom');
    rocketSprite.style.transform='translate(0px, 0px) rotate(14deg)';
    rocketCashoutBtn.disabled=true; rocketStartBtn.disabled=false;
    rocketBanner.classList.remove('show'); rocketBanner.style.opacity=0;
    if(rocketSky){ rocketSky.style.transform='translate(0,0)'; if(rocketCurve)rocketCurve.style.transform='scaleX(1)' }
  }
  rReset();

  function drawCrashAt(){
    const u=Math.random();
    const m=1+(-Math.log(1-u))*1.4;
    return Math.min(25,Math.max(1.05,+m.toFixed(2)));
  }
  function rLoop(){
    if(rState!=='running') return;
    const t=(performance.now()-rStart)/1000;
    const rate=.65;
    rMult=Math.exp(rate*t);
    if(rMult>=rCrashAt){ return rCrash() }
    rocketMultEl.textContent='x'+rMult.toFixed(2);
    const p=Math.min(1,Math.log(rMult)/Math.log(6));
    const stageW=document.querySelector('.rocket-stage').clientWidth;
    const padL=12,padR=10,shipW=44;
    const rangeX=stageW-padL-padR-shipW;
    const x=clamp(p*rangeX,0,rangeX);
    const y=clamp(-p*110,-120,0);
    rocketSprite.style.transform=`translate(${x}px, ${y}px) rotate(14deg)`;
    if(rocketSky){ const parX=-p*60; const parY=p*14; rocketSky.style.transform=`translate(${parX}px, ${parY}px)` }
    if(rocketCurve){ rocketCurve.style.transform=`scaleX(${1+p*0.15}) skewX(${-6*p}deg)` }
    const auto=parseFloat(rocketAutoInput.value||'0');
    if(auto>=1.01 && rMult>=auto){ rCashout(); return }
    rReq=requestAnimationFrame(rLoop);
  }
  function rStartRound(){
    const v=Math.max(1,Math.floor(parseInt(rocketBetInput.value||'0',10)));
    if(!tryBuy(v)){
      rocketBanner.textContent='Нужно больше 💵'; rocketBanner.style.color='#f87171';
      rocketBanner.classList.add('show'); setTimeout(()=>rocketBanner.classList.remove('show'),700);
      return;
    }
    rBet=v; rCrashAt=drawCrashAt(); rStart=performance.now();
    rState='running'; rocketStartBtn.disabled=true; rocketCashoutBtn.disabled=false;
    rocketBanner.classList.remove('show'); stopRocketLoop(); rReq=requestAnimationFrame(rLoop);
  }
  function rCashout(){
    if(rState!=='running') return;
    const win=Math.max(0,Math.floor(rBet*rMult));
    gainStars(win); refreshUI(); queueSave();
    rState='cashed'; rocketCashoutBtn.disabled=true;
    rocketBanner.textContent=`Вывел x${rMult.toFixed(2)} → +${win} 💵`; rocketBanner.style.color='#86efac';
    rocketBanner.classList.add('show'); setTimeout(()=>rReset(),1100);
  }
  function rCrash(){
    rState='crashed'; rocketCashoutBtn.disabled=true;
    rocketSprite.classList.add('boom');
    rocketBanner.textContent=`Взорвалась на x${rMult.toFixed(2)} :(`; rocketBanner.style.color='#fca5a5';
    rocketBanner.classList.add('show'); setTimeout(()=>rReset(),1200);
  }
  rBetPlus?.addEventListener('click',()=>{ let v=parseInt(rocketBetInput.value||'0',10); if(!Number.isFinite(v))v=0; v+=10; if(v<1)v=1; rocketBetInput.value=String(v) });
  rBetMinus?.addEventListener('click',()=>{ let v=parseInt(rocketBetInput.value||'0',10); if(!Number.isFinite(v))v=0; v=Math.max(1,v-10); rocketBetInput.value=String(v) });
  rocketBetInput?.addEventListener('input',()=>{ let v=parseInt(rocketBetInput.value||'0',10); if(!Number.isFinite(v)||v<1)v=1; rocketBetInput.value=String(v) });
  rAuto2?.addEventListener('click',()=>{ rocketAutoInput.value='2' });
  rAuto3?.addEventListener('click',()=>{ rocketAutoInput.value='3' });
  rocketAutoInput?.addEventListener('input',()=>{ let v=parseFloat(rocketAutoInput.value||'0'); if(!Number.isFinite(v)||v<0)v=0; rocketAutoInput.value=String(v) });
  rocketStartBtn?.addEventListener('click',()=>{ if(rState==='idle') rStartRound() });
  rocketCashoutBtn?.addEventListener('click',()=>{ rCashout() });

  // Табы мини-игр
  const tabMiniSlots=document.getElementById('tabMiniSlots');
  const tabMiniRocket=document.getElementById('tabMiniRocket');
  const gameSlotsWrap=document.getElementById('gameSlots');
  const gameRocketWrap=document.getElementById('gameRocket');
  function showMini(which){
    if(which==='slots'){
      gameSlotsWrap.classList.remove('hidden');
      gameRocketWrap.classList.add('hidden');
      tabMiniSlots.classList.add('outline');
      tabMiniRocket.classList.remove('outline');
      stopRocketLoop(); rReset();
    } else {
      gameSlotsWrap.classList.add('hidden');
      gameRocketWrap.classList.remove('hidden');
      tabMiniRocket.classList.add('outline');
      tabMiniSlots.classList.remove('outline');
    }
  }
  tabMiniSlots?.addEventListener('click',()=>showMini('slots'));
  tabMiniRocket?.addEventListener('click',()=>showMini('rocket'));
  showMini('slots');

  // ===== СКИНЫ =====
  function skinCardHTML(item){
    const owned=!!ownedSkins[item.key];
    const equipped=owned && activeSkin===item.key;
    const equipBtn= owned
      ? `<button id="skin-${item.key}-equip" class="px-3 py-1 rounded-md ${equipped?'bg-emerald-500/80 hover:bg-emerald-500':'bg-blue-500/30 hover:bg-blue-500/50'} font-semibold">${equipped?'Снять':'Надеть'}</button>`
      : `<button id="skin-${item.key}-buy" class="px-3 py-1 rounded-md bg-yellow-500/30 hover:bg-yellow-500/50 font-semibold">Купить за ${SKIN_PRICE} 💵</button>`;
    return `<div class="bg-white/10 p-3 rounded-lg flex gap-3 items-center">
      <img src="${item.img}" alt="${item.name}" class="w-16 h-16 object-contain rounded-md bg-black/30">
      <div class="flex-1">
        <button class="skin-name text-left font-semibold underline decoration-dotted" data-skin="${item.key}">${item.name}</button>
        <div class="text-xs text-white/70">${owned?(equipped?'Надето':'Куплено'):'Цена: '+SKIN_PRICE+' 💵'}</div>
      </div>
      <div class="grid gap-2 justify-items-end">${equipBtn}</div>
    </div>`;
  }
  function dogCardHTML(){
    const owned=!!ownedSkins['dog'];
    const equipped=owned && activePet==='dog';
    return `<div class="bg-white/10 p-3 rounded-lg flex gap-3 items-center">
      <img src="${DOG_URL}" alt="Собака" class="w-16 h-16 object-contain rounded-md bg-black/30">
      <div class="flex-1"><div class="font-semibold">Собака</div><div class="text-xs text-white/70">${owned?'Питомец доступен':'Будет стоять справа от героя'}</div></div>
      <div class="grid gap-2 justify-items-end">
        ${owned?`<button id="skin-dog-equip" class="px-3 py-1 rounded-md ${equipped?'bg-emerald-500/80 hover:bg-emerald-500':'bg-blue-500/30 hover:bg-blue-500/50'} font-semibold">${equipped?'Убрать':'Включить'}</button>`:`<button id="skin-dog-buy" class="px-3 py-1 rounded-md bg-yellow-500/30 hover:bg-yellow-500/50 font-semibold">Купить за ${SKIN_PRICE} 💵</button>`}
      </div>
    </div>`;
  }
  const skinsListEl=document.getElementById('skins-list');
  const previewWrap=document.getElementById('skin-preview');
  const previewImg=document.getElementById('skin-preview-img');
  const previewName=document.getElementById('skin-preview-name');
  const previewBuy=document.getElementById('skin-preview-buy');
  const previewEquip=document.getElementById('skin-preview-equip');
  const previewClose=document.getElementById('skin-preview-close');
  let previewKey='';

  function openSkinPreviewByKey(key){
    const item=CHARACTER_SKINS.find(s=>s.key===key); if(!item) return;
    previewKey=key; previewImg.src=item.img; previewName.textContent=item.name;
    const owned=!!ownedSkins[key]; const equipped=owned&&activeSkin===key;
    previewBuy.style.display=owned?'none':'inline-flex';
    previewEquip.textContent=equipped?'Снять':'Надеть';
    previewWrap.classList.remove('hidden'); previewWrap.classList.add('flex');
  }
  function closeSkinPreview(){ previewWrap.classList.add('hidden'); previewWrap.classList.remove('flex') }
  previewClose?.addEventListener('click',closeSkinPreview);
  previewWrap?.addEventListener('click',(e)=>{ if(e.target===previewWrap) closeSkinPreview() });

  function renderSkinsUI(){
    if(!skinsListEl) return;
    let html=''; html+='<div class="text-xs uppercase tracking-wide text-white/60">Персонажи</div>';
    for(const item of CHARACTER_SKINS){ html+=skinCardHTML(item) }
    html+='<div class="text-xs uppercase tracking-wide text-white/60 mt-2">Питомцы</div>';
    html+=dogCardHTML();
    skinsListEl.innerHTML=html;

    for(const item of CHARACTER_SKINS){
      const buyBtn=document.getElementById(`skin-${item.key}-buy`);
      const eqBtn=document.getElementById(`skin-${item.key}-equip`);
      const nameBtn=[...document.querySelectorAll('.skin-name')].find(b=>b.getAttribute('data-skin')===item.key);
      if(buyBtn){ buyBtn.addEventListener('click',()=>{ if(tryBuy(SKIN_PRICE)){ ownedSkins[item.key]=true; activeSkin=item.key; refreshUI(); queueSave(true) } else { alert('Нужно '+SKIN_PRICE+' 💵') } }); }
      if(eqBtn){ eqBtn.addEventListener('click',()=>{ if(!ownedSkins[item.key])return; activeSkin=(activeSkin===item.key)?'':item.key; refreshUI(); queueSave(true); }); }
      if(nameBtn){ nameBtn.addEventListener('click',()=> openSkinPreviewByKey(item.key)) }
    }
    const dogBuy=document.getElementById('skin-dog-buy');
    const dogEq=document.getElementById('skin-dog-equip');
    if(dogBuy){ dogBuy.addEventListener('click',()=>{ if(tryBuy(SKIN_PRICE)){ ownedSkins['dog']=true; activePet='dog'; refreshUI(); queueSave(true) } else { alert('Нужно '+SKIN_PRICE+' 💵') } }); }
    if(dogEq){ dogEq.addEventListener('click',()=>{ activePet=(activePet==='dog')?'':'dog'; refreshUI(); queueSave(true); }); }
  }
  previewBuy?.addEventListener('click',()=>{ const key=previewKey; if(!key) return; if(tryBuy(SKIN_PRICE)){ ownedSkins[key]=true; activeSkin=key; refreshUI(); queueSave(true); closeSkinPreview() } else { alert('Нужно '+SKIN_PRICE+' 💵') } });
  previewEquip?.addEventListener('click',()=>{ const key=previewKey; if(!key) return; if(!ownedSkins[key]){ alert('Скин не куплен'); return } activeSkin=(activeSkin===key)?'':key; refreshUI(); queueSave(true); closeSkinPreview(); });

  // Первичный рендер
  refreshUI();

  // ===== Прелоадер ассетов (мягкий) =====
  (function initPreloader(){
    const preloader=document.getElementById('preloader');
    const preloaderFill=document.getElementById('preloader-fill');
    if(!preloader||!preloaderFill)return;
    const minShow=800; const start=performance.now();
    function setProgress(p){
      const v=Math.max(0,Math.min(100,p));
      preloaderFill.style.width=v+'%';
      preloader.querySelector('.preloader-bar')?.setAttribute('aria-valuenow',String(Math.round(v)));
    }
    const assets=Array.from(new Set([ ...(BG_BY_LEVEL||[]), ...(CHAR_BY_LEVEL||[]), INTRO_VERA, DOG_URL, ...CHARACTER_SKINS.map(s=>s.img), 'https://i.postimg.cc/TP1Cy2ZT/photo-2024-11-20-16-11-48.jpg' ]));
    let loaded=0;
    function loadImg(u,timeout=6000){
      return new Promise((resolve)=>{
        const img=new Image(); let done=false;
        const finish=()=>{ if(done) return; done=true; loaded++; setProgress(10+(assets.length?(loaded/assets.length)*80:80)); resolve() };
        const to=setTimeout(finish,timeout);
        img.onload=()=>{clearTimeout(to);finish()};
        img.onerror=()=>{clearTimeout(to);finish()};
        img.src=u;
      })
    }
    let fake=0; const tick=setInterval(()=>{ fake=Math.min(95,fake+2+Math.random()*3); setProgress(fake) },140);
    function hide(){ clearInterval(tick); setProgress(100); preloader.classList.add('hidden'); try{ window.showIntro?.() }catch(_){} }
    const hardFallback=setTimeout(hide,9000);
    Promise.allSettled(assets.map(u=>loadImg(u))).then(()=>{
      const elapsed=performance.now()-start; const delay=Math.max(0,minShow-elapsed);
      setTimeout(()=>{ clearTimeout(hardFallback); hide() },delay)
    });
    window.addEventListener('load',()=>{
      const elapsed=performance.now()-start; const delay=Math.max(0,minShow-elapsed);
      setTimeout(()=>{ clearTimeout(hardFallback); hide() },delay)
    },{once:true});
  })();

  // ===== ИНИЦ TG-АВАТАРА =====
  (function initTelegramUser(){
    const wa=window.Telegram&&window.Telegram.WebApp?window.Telegram.WebApp:null;
    const box=document.getElementById('tgUser');
    const ava=document.getElementById('tgAva');
    if(!wa||!box||!ava) return;
    try{ wa.ready() }catch(_){}
    const u=(wa.initDataUnsafe&&wa.initDataUnsafe.user)?wa.initDataUnsafe.user:null;
    if(!u){ return }
    const username=u.username?u.username:'';
    ava.src=u.photo_url||'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    box.classList.add('show');
    box.addEventListener('click',()=>{ if(username&&typeof wa.openTelegramLink==='function'){ wa.openTelegramLink('https://t.me/'+username); } });
  })();
});
</script>
</body>
</html>









